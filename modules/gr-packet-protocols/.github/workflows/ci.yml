name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  CMAKE_BUILD_TYPE: Release
  CMAKE_INSTALL_PREFIX: /usr

jobs:
  build:
    name: Build on Ubuntu ${{ matrix.ubuntu-version }}
    runs-on: ubuntu-${{ matrix.ubuntu-version }}
    strategy:
      fail-fast: false
      matrix:
        ubuntu-version: ['20.04', '22.04', '24.04']
        python-bindings: [true, false]
        include:
          - ubuntu-version: '22.04'
            python-bindings: true
            test-python: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        if: matrix.python-bindings == true
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            gnuradio-dev \
            gnuradio \
            libboost-all-dev \
            liblog4cpp5-dev \
            libzmq3-dev \
            libfftw3-dev \
            libgsl-dev \
            python3-dev \
            python3-numpy \
            python3-pip

      - name: Install pybind11 (if Python bindings enabled)
        if: matrix.python-bindings == true
        run: |
          python3 -m pip install pybind11

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_INSTALL_PREFIX=${{ env.CMAKE_INSTALL_PREFIX }} \
            -DENABLE_PYTHON=${{ matrix.python-bindings }}

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Check library exists
        run: |
          test -f build/libgnuradio-packet_protocols.so* || exit 1
          echo "Library built successfully"

      - name: Check Python bindings (if enabled)
        if: matrix.python-bindings == true
        run: |
          test -f build/packet_protocols_python*.so || exit 1
          echo "Python bindings built successfully"

      - name: Test Python import (if enabled)
        if: matrix.python-bindings == true && matrix.test-python == true
        run: |
          cd build
          export LD_LIBRARY_PATH=$PWD:$LD_LIBRARY_PATH
          export PYTHONPATH=$PWD:$PYTHONPATH
          python3 -c "import sys; sys.path.insert(0, '.'); import packet_protocols_python; print('Python bindings import successful')" || exit 1

      - name: Validate GRC block files
        run: |
          for file in grc/*.block.yml; do
            if [ ! -f "$file" ]; then
              echo "Error: GRC block file $file not found"
              exit 1
            fi
            if ! grep -q "file_format:" "$file"; then
              echo "Error: $file missing file_format field"
              exit 1
            fi
            echo "Validated: $file"
          done

      - name: Check for compilation warnings
        run: |
          cd build
          if grep -i "warning" compile_commands.json 2>/dev/null || true; then
            echo "Build completed with warnings (check logs above)"
          fi

  lint:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Check code formatting
        run: |
          files=$(find . -name "*.cc" -o -name "*.cpp" -o -name "*.h" -o -name "*.hpp" | grep -v build | grep -v ".git" || true)
          if [ -z "$files" ]; then
            echo "No source files found to format"
            exit 0
          fi
          echo "$files" | xargs clang-format --dry-run --Werror || \
            (echo "Code formatting check failed. Run 'clang-format -i' on the files above." && exit 1)

  validate-grc:
    name: Validate GRC Block Definitions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GNU Radio
        run: |
          sudo apt-get update
          sudo apt-get install -y gnuradio gnuradio-dev

      - name: Install PyYAML
        run: |
          python3 -m pip install pyyaml

      - name: Validate YAML syntax
        run: |
          for file in grc/*.block.yml; do
            echo "Validating $file..."
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done

      - name: Check required fields
        run: |
          for file in grc/*.block.yml; do
            echo "Checking required fields in $file..."
            python3 << EOF
          import yaml
          import sys
          with open('$file') as f:
              data = yaml.safe_load(f)
          required = ['id', 'label', 'category', 'file_format']
          for field in required:
              if field not in data:
                  print(f"Error: {field} missing in $file")
                  sys.exit(1)
          print(f"All required fields present in $file")
          EOF
          done

  install-test:
    name: Installation Test
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            gnuradio-dev \
            gnuradio \
            libboost-all-dev \
            liblog4cpp5-dev \
            libzmq3-dev \
            libfftw3-dev \
            libgsl-dev \
            python3-dev \
            python3-numpy \
            python3-pip

      - name: Install pybind11
        run: |
          python3 -m pip install pybind11

      - name: Build and install
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DENABLE_PYTHON=ON
          make -j$(nproc)
          sudo make install
          sudo ldconfig

      - name: Verify installation paths
        run: |
          test -f /usr/lib/x86_64-linux-gnu/libgnuradio-packet_protocols.so* || exit 1
          test -d /usr/share/gnuradio/grc/blocks || exit 1
          ls -la /usr/share/gnuradio/grc/blocks/*.block.yml || exit 1
          echo "Installation verification successful"

      - name: Test uninstall target
        run: |
          cd build
          sudo make uninstall || exit 1
          if [ -f /usr/lib/x86_64-linux-gnu/libgnuradio-packet_protocols.so* ]; then
            echo "Error: Library still exists after uninstall"
            exit 1
          fi
          echo "Uninstall test successful"

